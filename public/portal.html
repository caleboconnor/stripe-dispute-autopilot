<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merchant Portal - Dispute Autopilot</title>
  <style>
    body { font-family: Inter, system-ui, Arial, sans-serif; margin: 0; background: #0b1020; color: #e6ebff; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background: #121933; border: 1px solid #263059; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 10px; }
    input, select { background: #0d1430; color: #e6ebff; border: 1px solid #2f3a69; border-radius: 8px; padding: 10px; }
    button { background: #4f7cff; border: none; color: white; padding: 8px 12px; border-radius: 10px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #22305e; font-size: 13px; }
    th { color: #aebfff; }
    .muted { color: #95a8de; }
    .ok { color: #7ce38b; }
    .kpi { background:#0d1430; border:1px solid #2b396f; border-radius:10px; padding:10px; }
    .kpi .v { font-size:20px; font-weight:700; }
    .modal { position: fixed; inset:0; background: rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
    .modal .panel { width:min(900px,92vw); max-height:85vh; overflow:auto; background:#101733; border:1px solid #2a3d7a; border-radius:12px; padding:16px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Merchant Portal</h1>
  <p class="muted">Connect Stripe, monitor disputes, tune automation, and retry submissions.</p>

  <div class="card">
    <h3>Connect Stripe</h3>
    <div class="row">
      <input id="merchantName" placeholder="Merchant name" />
      <button id="connectBtn">Connect Stripe</button>
      <span id="connectState" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>Merchant + Settings</h3>
    <div class="row">
      <select id="merchantFilter"><option value="">Select merchant</option></select>
      <button id="refreshBtn">Refresh</button>
      <button id="runSweepBtn">Run Submission Sweep</button>
      <button id="optimizeReasonsBtn">Optimize Reasons</button>
    </div>
    <div class="row" style="margin-top:10px;">
      <label><input type="checkbox" id="autoSubmitEnabled" /> Auto-submit enabled</label>
      <input id="minEvidenceScore" type="number" min="0" max="100" placeholder="Min score" />
      <input id="manualReviewThreshold" type="number" min="0" placeholder="Manual review threshold (cents)" />
      <input id="autoSubmitReasons" placeholder="Reason codes (comma separated)" style="min-width:320px;" />
      <input id="monthlyTransactionCount" type="number" min="1" placeholder="Monthly transaction count" />
      <input id="ratioThresholdPct" type="number" min="0" step="0.01" placeholder="Dispute ratio alert %" />
      <input id="submissionDelayMinutes" type="number" min="0" step="1" placeholder="Submission delay (minutes)" />
      <button id="saveSettingsBtn">Save settings</button>
    </div>
    <hr style="border-color:#25325f; margin:14px 0;" />
    <h4>Evidence Profile (Info Product / Coaching)</h4>
    <div class="row">
      <input id="termsUrl" placeholder="Terms URL" style="min-width:260px;" />
      <input id="refundPolicyUrl" placeholder="Refund policy URL" style="min-width:260px;" />
      <input id="cancellationPolicyUrl" placeholder="Cancellation policy URL" style="min-width:260px;" />
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="productDescriptionTemplate" placeholder="Product description template" style="min-width:520px;" />
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="onboardingProofTemplate" placeholder="Onboarding proof template" style="min-width:520px;" />
      <input id="deliveryProofTemplate" placeholder="Delivery proof template" style="min-width:520px;" />
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="supportPolicyTemplate" placeholder="Support policy template" style="min-width:520px;" />
      <button id="saveEvidenceBtn">Save evidence profile</button>
    </div>
  </div>

  <div class="card">
    <h3>KPIs</h3>
    <div class="grid" id="kpis"></div>
  </div>

  <div class="card">
    <h3>AI Recommendations</h3>
    <ul id="recs" class="muted"></ul>
  </div>

  <div class="card">
    <h3>Win/Loss by Reason</h3>
    <table>
      <thead><tr><th>Reason</th><th>Total</th><th>Won</th><th>Lost</th></tr></thead>
      <tbody id="reasonRows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Disputes</h3>
    <div class="row" style="margin-bottom:10px;">
      <select id="statusFilter">
        <option value="">All statuses</option>
        <option value="warning_needs_response">Needs response</option>
        <option value="warning_under_review">Under review</option>
        <option value="won">Won</option>
        <option value="lost">Lost</option>
      </select>
      <input id="reasonFilter" placeholder="Filter by reason code" />
    </div>
    <table>
      <thead>
      <tr>
        <th>ID</th><th>Reason</th><th>Status</th><th>Amount</th><th>Score</th><th>Review?</th><th>Due</th><th>Submitted</th><th>Deflected</th><th>Action</th><th>Details</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>


<div class="modal" id="detailModal">
  <div class="panel">
    <div class="row" style="justify-content:space-between;">
      <h3>Dispute Details</h3><button id="closeDetailBtn">Close</button>
    </div>
    <pre id="detailBody" style="white-space:pre-wrap; color:#dbe6ff; font-size:12px;"></pre>
  </div>
</div>

<script>
const merchantFilter = document.getElementById('merchantFilter');
const rows = document.getElementById('rows');
const connectState = document.getElementById('connectState');
const kpisEl = document.getElementById('kpis');
const recsEl = document.getElementById('recs');
const reasonRows = document.getElementById('reasonRows');
const statusFilter = document.getElementById('statusFilter');
const reasonFilter = document.getElementById('reasonFilter');
const detailModal = document.getElementById('detailModal');
const detailBody = document.getElementById('detailBody');

let merchants = [];
let cachedDisputes = [];
let selectedMerchant = null;

const fmtMoney = (amount, currency='usd') => new Intl.NumberFormat(undefined, { style: 'currency', currency: (currency || 'usd').toUpperCase() }).format((amount || 0)/100);
const fmtDate = (ts) => ts ? new Date(ts * 1000).toLocaleString() : 'â€”';

async function loadMerchants() {
  const r = await fetch('/api/merchants');
  const data = await r.json();
  merchants = data.merchants || [];
  merchantFilter.innerHTML = '<option value="">Select merchant</option>' + merchants.map(m => `<option value="${m.id}">${m.name} (${m.stripeAccountId})</option>`).join('');
  const prev = selectedMerchant?.id;
  if (prev) merchantFilter.value = prev;
  selectedMerchant = merchants.find(m => m.id === merchantFilter.value) || null;
  hydrateSettings();
}

function hydrateSettings() {
  const s = selectedMerchant?.settings;
  const e = selectedMerchant?.evidenceProfile || {};
  document.getElementById('autoSubmitEnabled').checked = !!s?.autoSubmitEnabled;
  document.getElementById('minEvidenceScore').value = s?.minEvidenceScore ?? 70;
  document.getElementById('manualReviewThreshold').value = s?.manualReviewAmountThreshold ?? 200000;
  document.getElementById('autoSubmitReasons').value = (s?.autoSubmitReasons || []).join(',');
  document.getElementById('monthlyTransactionCount').value = s?.monthlyTransactionCount ?? 1000;
  document.getElementById('ratioThresholdPct').value = s?.monthlyDisputeAlertThresholdPct ?? 0.9;
  document.getElementById('submissionDelayMinutes').value = s?.submissionDelayMinutes ?? 0;

  document.getElementById('termsUrl').value = e.termsUrl || '';
  document.getElementById('refundPolicyUrl').value = e.refundPolicyUrl || '';
  document.getElementById('cancellationPolicyUrl').value = e.cancellationPolicyUrl || '';
  document.getElementById('productDescriptionTemplate').value = e.productDescriptionTemplate || '';
  document.getElementById('onboardingProofTemplate').value = e.onboardingProofTemplate || '';
  document.getElementById('deliveryProofTemplate').value = e.deliveryProofTemplate || '';
  document.getElementById('supportPolicyTemplate').value = e.supportPolicyTemplate || '';
}

async function loadMetrics() {
  if (!merchantFilter.value) {
    kpisEl.innerHTML = '<div class="muted">Select a merchant to view KPIs.</div>';
    return;
  }
  const r = await fetch('/metrics?merchantId=' + encodeURIComponent(merchantFilter.value));
  const data = await r.json();
  const m = data.metrics || {};
  const s = selectedMerchant?.settings || {};
  const ratioPct = s.monthlyTransactionCount ? (((m.monthlyDisputes || 0) / s.monthlyTransactionCount) * 100).toFixed(2) : '0.00';
  kpisEl.innerHTML = `
    <div class="kpi"><div class="muted">Total Disputes</div><div class="v">${m.total || 0}</div></div>
    <div class="kpi"><div class="muted">Win Rate</div><div class="v">${m.winRate || 0}%</div></div>
    <div class="kpi"><div class="muted">Recovered</div><div class="v">${fmtMoney(m.recoveredAmount || 0)}</div></div>
    <div class="kpi"><div class="muted">Avg Evidence Score</div><div class="v">${m.avgEvidenceScore || 0}</div></div>
    <div class="kpi"><div class="muted">Due in <48h</div><div class="v">${m.dueSoon || 0}</div></div>
    <div class="kpi"><div class="muted">Overdue Unsubmitted</div><div class="v">${m.overdue || 0}</div></div>
    <div class="kpi"><div class="muted">Monthly Dispute Ratio</div><div class="v">${ratioPct}%</div></div>
    <div class="kpi"><div class="muted">Ratio Alert Threshold</div><div class="v">${s.monthlyDisputeAlertThresholdPct ?? 0.9}%</div></div>
    <div class="kpi"><div class="muted">Deflected</div><div class="v">${m.deflected || 0}</div></div>
  `;

  const byReason = m.byReason || {};
  const entries = Object.entries(byReason);
  if (!entries.length) {
    reasonRows.innerHTML = '<tr><td colspan="4" class="muted">No reason-code stats yet.</td></tr>';
  } else {
    reasonRows.innerHTML = entries
      .map(([reason, v]) => `<tr><td>${reason}</td><td>${v.total}</td><td>${v.won}</td><td>${v.lost}</td></tr>`)
      .join('');
  }
}

async function loadRecommendations() {
  if (!merchantFilter.value) {
    recsEl.innerHTML = '<li>Select a merchant to view recommendations.</li>';
    return;
  }
  const r = await fetch('/recommendations?merchantId=' + encodeURIComponent(merchantFilter.value));
  const data = await r.json();
  const recs = data.recommendations || [];
  recsEl.innerHTML = recs.map(x => `<li>${x}</li>`).join('');
}

function renderDisputes(disputes) {
  if (!disputes.length) {
    rows.innerHTML = `<tr><td colspan="11" class="muted">No disputes match current filters.</td></tr>`;
    return;
  }
  rows.innerHTML = disputes.map(d => `
      <tr>
        <td title="${(d.evidenceSummary||[]).join(' | ')}">${d.id}</td>
        <td>${d.reason}</td>
        <td>${d.status}</td>
        <td>${fmtMoney(d.amount, d.currency)}</td>
        <td>${d.evidenceScore || 0}</td>
        <td>${d.manualReviewRequired ? 'Yes' : 'No'}</td>
        <td>${fmtDate(d.dueBy)}</td>
        <td>${d.submitted ? 'Yes' : 'No'}</td>
        <td title="${d.deflectionReason || ''}">${d.deflected ? 'Yes' : 'No'}</td>
        <td>
          <button onclick="retrySubmit('${d.id}')">Retry Submit</button>
          <button onclick="deflectDispute('${d.id}')">Deflect</button>
          <button onclick="viewEvidenceDraft('${d.id}')">Draft</button>
        </td>
        <td><button onclick="viewDispute('${d.id}')">View</button></td>
      </tr>
  `).join('');
}

function applyDisputeFilters() {
  const status = statusFilter.value;
  const reason = (reasonFilter.value || '').trim().toLowerCase();
  const filtered = cachedDisputes.filter(d => {
    if (status && d.status !== status) return false;
    if (reason && !(d.reason || '').toLowerCase().includes(reason)) return false;
    return true;
  });
  renderDisputes(filtered);
}

async function loadDisputes() {
  if (!merchantFilter.value) {
    cachedDisputes = [];
    rows.innerHTML = `<tr><td colspan="10" class="muted">Select a merchant.</td></tr>`;
    return;
  }
  const r = await fetch('/disputes?merchantId=' + encodeURIComponent(merchantFilter.value));
  const data = await r.json();
  cachedDisputes = data.disputes || [];
  applyDisputeFilters();
}


async function viewDispute(id) {
  const r = await fetch('/disputes/' + encodeURIComponent(id));
  const data = await r.json();
  detailBody.textContent = JSON.stringify(data.dispute || {}, null, 2);
  detailModal.style.display = 'flex';
}
window.viewDispute = viewDispute;

async function viewEvidenceDraft(id) {
  const r = await fetch('/disputes/' + encodeURIComponent(id) + '/evidence-draft');
  const data = await r.json();
  detailBody.textContent = JSON.stringify(data.draft || {}, null, 2);
  detailModal.style.display = 'flex';
}
window.viewEvidenceDraft = viewEvidenceDraft;

document.getElementById('closeDetailBtn').addEventListener('click', () => { detailModal.style.display = 'none'; });

async function retrySubmit(id) {
  const r = await fetch('/disputes/' + encodeURIComponent(id) + '/retry-submit', { method: 'POST' });
  if (!r.ok) {
    const j = await r.json().catch(() => ({}));
    alert('Retry failed: ' + (j.message || 'Unknown error'));
  } else {
    alert('Retry submitted.');
  }
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
}
window.retrySubmit = retrySubmit;

async function deflectDispute(id) {
  const ok = confirm('Issue a proactive refund for this dispute to deflect and protect chargeback ratio?');
  if (!ok) return;
  const r = await fetch('/disputes/' + encodeURIComponent(id) + '/deflect', { method: 'POST' });
  if (!r.ok) {
    const j = await r.json().catch(() => ({}));
    alert('Deflection failed: ' + (j.message || 'Unknown error'));
  } else {
    alert('Deflection refund issued.');
  }
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
}
window.deflectDispute = deflectDispute;

document.getElementById('connectBtn').addEventListener('click', () => {
  const name = document.getElementById('merchantName').value || 'Merchant';
  window.location.href = '/auth/stripe/start?merchantName=' + encodeURIComponent(name);
});

document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
  if (!merchantFilter.value) return alert('Select a merchant first.');
  const payload = {
    autoSubmitEnabled: document.getElementById('autoSubmitEnabled').checked,
    minEvidenceScore: Number(document.getElementById('minEvidenceScore').value || 70),
    manualReviewAmountThreshold: Number(document.getElementById('manualReviewThreshold').value || 200000),
    autoSubmitReasons: (document.getElementById('autoSubmitReasons').value || '').split(',').map(x => x.trim()).filter(Boolean),
    monthlyTransactionCount: Number(document.getElementById('monthlyTransactionCount').value || 1000),
    monthlyDisputeAlertThresholdPct: Number(document.getElementById('ratioThresholdPct').value || 0.9),
    submissionDelayMinutes: Number(document.getElementById('submissionDelayMinutes').value || 0)
  };
  const r = await fetch('/api/merchants/' + encodeURIComponent(merchantFilter.value) + '/settings', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!r.ok) return alert('Failed to save settings.');
  await loadMerchants();
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
  alert('Settings saved.');
});

document.getElementById('saveEvidenceBtn').addEventListener('click', async () => {
  if (!merchantFilter.value) return alert('Select a merchant first.');
  const payload = {
    termsUrl: document.getElementById('termsUrl').value,
    refundPolicyUrl: document.getElementById('refundPolicyUrl').value,
    cancellationPolicyUrl: document.getElementById('cancellationPolicyUrl').value,
    productDescriptionTemplate: document.getElementById('productDescriptionTemplate').value,
    onboardingProofTemplate: document.getElementById('onboardingProofTemplate').value,
    deliveryProofTemplate: document.getElementById('deliveryProofTemplate').value,
    supportPolicyTemplate: document.getElementById('supportPolicyTemplate').value,
    businessType: 'info_coaching'
  };
  const r = await fetch('/api/merchants/' + encodeURIComponent(merchantFilter.value) + '/evidence-profile', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!r.ok) return alert('Failed to save evidence profile.');
  await loadMerchants();
  alert('Evidence profile saved.');
});

merchantFilter.addEventListener('change', async () => {
  selectedMerchant = merchants.find(m => m.id === merchantFilter.value) || null;
  hydrateSettings();
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
});

document.getElementById('refreshBtn').addEventListener('click', async () => {
  await loadMerchants();
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
});

document.getElementById('runSweepBtn').addEventListener('click', async () => {
  await fetch('/jobs/run-submissions', { method: 'POST' });
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
  alert('Submission sweep completed.');
});

document.getElementById('optimizeReasonsBtn').addEventListener('click', async () => {
  if (!merchantFilter.value) return alert('Select a merchant first.');
  const r = await fetch('/api/merchants/' + encodeURIComponent(merchantFilter.value) + '/optimize-reasons', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ minCases: 3, minWinRatePct: 30 })
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) return alert('Failed to optimize reasons.');
  const risky = (data.riskyReasons || []).join(', ') || 'none';
  await loadMerchants();
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
  alert('Reason optimization completed. Risky reasons: ' + risky);
});

statusFilter.addEventListener('change', applyDisputeFilters);
reasonFilter.addEventListener('input', applyDisputeFilters);

if (new URLSearchParams(location.search).get('connected') === '1') {
  connectState.textContent = 'Stripe account connected.';
  connectState.className = 'ok';
}

loadMerchants().then(async () => {
  await loadDisputes();
  await loadMetrics();
  await loadRecommendations();
});
</script>
</body>
</html>
